<html>
<head>
<title>WebGL</title>

<style>
#viewport { width: 640px; height: 480px; }
</style>

<script type="text/javascript" src="http://webkit.org/blog-files/webgl/resources/J3DI.js"></script>
<script type="text/javascript" src="http://webkit.org/blog-files/webgl/resources/J3DIMath.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.min.js"></script>

</head>
<body>
<canvas id="viewport" />

<script id="vertex_shader" type="x-shader/x-vertex">

#define M_PI 3.14159265358979323846

uniform mat4 modelViewProjMatrix;
attribute vec2 vPosition;

void main(void) {
	float lam = radians(vPosition.x);
	float phi = radians(vPosition.y);
	
	gl_Position.x = lam;
	gl_Position.y = phi;	//log(tan(M_PI/4.0 + phi/2.0));
	gl_Position.z = 0.0;
	gl_Position.w = 1.0;
    gl_Position = modelViewProjMatrix * gl_Position;
	gl_PointSize = 1.0;
}

</script>

<script id="fragment_shader" type="x-shader/x-fragment">

void main(void) {
    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
}

</script>


<script type="text/javascript">
//var gl;
var modelViewProjMatrixLoc, viewTransform, vPositionIdx, vertices, vertexBuffer;

gl = document.getElementById('viewport').getContext('experimental-webgl');
gl.console = ("console" in window) ? window.console : { log: function() { } };

gl.program = gl.createProgram();
gl.attachShader(gl.program, loadShader(gl, 'vertex_shader'));
gl.attachShader(gl.program, loadShader(gl, 'fragment_shader'));
gl.linkProgram(gl.program);
gl.useProgram(gl.program);

// modelViewProjMatrix
modelViewProjMatrixLoc = gl.getUniformLocation(gl.program, 'modelViewProjMatrix');
viewTransform = new J3DIMatrix4();
viewTransform.scale(5);
viewTransform.translate(-0.1, -0.85);
gl.uniformMatrix4fv(modelViewProjMatrixLoc, false, viewTransform.getAsFloat32Array());

// vPosition
vPositionIdx = gl.getAttribLocation(gl.program, 'vPosition');
gl.enableVertexAttribArray(vPositionIdx);
vertexBuffer = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
gl.vertexAttribPointer(vPositionIdx, 2, gl.FLOAT, false, 0, 0);

gl.clearColor(0,0,0,1);
gl.clearDepth(1);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

function drawShape(vertexArray) {
	var vertices;

	// unzip the vertexArray
	vertices = new Float32Array(vertexArray.length * 2);
	vertexArray.forEach(function (pair, i) {
		//if (i % 50) return;
		vertices.set(pair, 2*i);
	});
	
	gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STREAM_DRAW);
	gl.drawArrays(gl.POINTS, 0, vertices.length / 2);
}


var countryList = [];
countryList.push('09cbb20a3a888441c4cd58c36b04cceb');	// Netherlands
countryList.push('09cbb20a3a888441c4cd58c36b029490');	// Germany

countryList.forEach(function (docId) {
	$.get("http://localhost:5984/countries/" + docId, function (doc) {
		doc.geometry.coordinates.forEach(function (polygon) {
			drawShape(polygon[0]);
		});
	}, 'json');
});

</script>

</body>
</html>